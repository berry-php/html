#!/usr/bin/env php
<?php declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

function generate(string $elementsDir, string $namespace, string $namespaceElements, ?string $outputFile): void
{
    $elementsDir = realpath($elementsDir);
    if ($elementsDir === false) {
        return;
    }

    $files = glob("$elementsDir/*.php");
    if ($files === false) {
        return;
    }

    $buffer = [];
    $buffer[] = "<?php declare(strict_types=1);\n";
    $buffer[] = "\n";
    $buffer[] = "namespace {$namespace};\n";
    $buffer[] = "\n";
    $buffer[] = "// This file was automatically generated and should not be edited manually\n";
    $buffer[] = "\n";

    $entries = [];

    foreach ($files as $file) {
        $className = basename($file, '.php');
        $fqdn = $namespaceElements . '\\' . $className;
        $funcName = strtolower($className);

        $buffer[] = "use {$fqdn};\n";

        $docBlock = null;

        try {
            // @phpstan-ignore-next-line
            $rc = new \ReflectionClass($fqdn);
            $docBlock = $rc->getDocComment();
        } catch (\Throwable $e) {
            $docBlock = null;
        }

        $entries[] = [$funcName, $className, $docBlock];
    }

    $buffer[] = "\n";

    foreach ($entries as [$funcName, $className, $docBlock]) {
        if ($docBlock !== null && $docBlock !== false) {
            $docBlockNorm = preg_replace("/\r\n?/", "\n", $docBlock);
            $buffer[] = "$docBlockNorm\n";
        }
        $buffer[] = "function {$funcName}(): {$className}\n";
        $buffer[] = "{\n";
        $buffer[] = "    return new {$className}();\n";
        $buffer[] = "}\n\n";
    }

    $res = implode('', $buffer);

    if ($outputFile !== null) {
        $outputDir = dirname($outputFile);
        if (!is_dir($outputDir)) {
            mkdir($outputDir, 0755, true);
        }

        file_put_contents($outputFile, $res);
        $num = count($entries);
        echo "Wrote $num functions to $outputFile\n";
        return;
    }

    echo $res;
}

generate(
    __DIR__ . '/../src/Html/Elements',
    'Berry\Html',
    'Berry\Html\Elements',
    __DIR__ . '/../src/Html/functions.php',
);

?>
